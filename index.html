<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Extended Session [PsychoJS]</title>
    <!-- styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="./lib/psychojs-2021.2.3.css">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./eye-favicon.svg">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYAhgYGAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBGCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYAj///8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYAj///8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    
    <!-- Page initialization and error handling -->
    <script>
      // Debug logging
      const debugLog = [];
      function addDebugMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] ${message}`;
        debugLog.push(entry);
        console.log(entry);
        
        // Update debug panel if it exists
        const debugPanel = document.getElementById('debug-panel');
        if (debugPanel) {
          debugPanel.textContent = debugLog.join('\n');
          debugPanel.scrollTop = debugPanel.scrollHeight;
        }
      }

      // Error display
      function showError(message, details) {
        console.error(message, details);
        
        // Add to debug log
        addDebugMessage(`ERROR: ${message}`);
        
        // Create error panel if it doesn't exist
        let errorPanel = document.getElementById('error-panel');
        if (!errorPanel) {
          errorPanel = document.createElement('div');
          errorPanel.id = 'error-panel';
          errorPanel.style = 'position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(255,0,0,0.9); color: white; padding: 15px; border-radius: 5px; font-family: sans-serif; z-index: 9999; max-width: 80%; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
          document.body.appendChild(errorPanel);
        }
        
        errorPanel.innerHTML = `
          <h3 style="margin-top: 0;">Error</h3>
          <p>${message}</p>
          ${details ? `<pre style="background: rgba(0,0,0,0.3); padding: 8px; overflow: auto; max-height: 200px; font-size: 12px;">${details}</pre>` : ''}
          <button onclick="this.parentNode.style.display='none';" style="background: white; color: red; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 10px;">Dismiss</button>
        `;
      }
      
      // Global error handler
      window.addEventListener('error', function(e) {
        showError(`JavaScript Error: ${e.message}`, e.error ? e.error.stack : null);
        
        // Special handling for resource loading errors
        if (e.message.includes('404') || e.message.includes('Failed to load resource')) {
          console.error('Resource failed to load:', e.target.src || e.target.href);
          document.getElementById('root').innerHTML = '<div style="color: red; margin: 20px; font-family: sans-serif;">' +
            '<h1>Error Loading Resources</h1>' +
            '<p>Failed to load: ' + (e.target.src || e.target.href) + '</p>' +
            '<p>Please check that all files are present in the correct location.</p>' +
            '</div>';
        }
      }, true);
      
      // Handle unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        showError(`Unhandled Promise rejection: ${e.reason}`, e.reason.stack);
        addDebugMessage('UNHANDLED PROMISE REJECTION: ' + e.reason);
      });
      
      // Initialize page
      addDebugMessage('Page loaded and debug logging initialized');
    </script>
    
    <!-- External libraries - load first to ensure availability -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/preloadjs@1.0.1/lib/preloadjs.min.js"></script>
    
    <!-- PsychoJS configuration - init early to ensure it's available -->
    <script>
      window.psychoJS = {
        debug: true,
        collectIP: false,
        hosts: {
          local: '',
          pavlovia: 'https://pavlovia.org'
        },
        log: function() {
          if (window.psychoJS.debug) {
            console.log.apply(console, arguments);
          }
        },
        version: '2021.2.3'
      };
      
      addDebugMessage('PsychoJS stub initialized');
      
      // AudioContext handling for warnings
      window.fixAudioContext = function() {
        // Find any AudioContext instances that might exist
        if (typeof window.AudioContext !== 'undefined' || typeof window.webkitAudioContext !== 'undefined') {
          const AudioContextClass = window.AudioContext || window.webkitAudioContext;
          
          // Patch the AudioContext prototype
          const originalConstructor = AudioContextClass;
          window.AudioContext = window.webkitAudioContext = function() {
            const instance = new originalConstructor();
            
            // Automatically resume on user interaction
            const resumeAudio = function() {
              if (instance.state !== 'running') {
                instance.resume().then(function() {
                  console.log('AudioContext resumed successfully');
                }).catch(function(err) {
                  console.warn('Failed to resume AudioContext:', err);
                });
              }
            };
            
            // Add listeners for user interactions
            document.addEventListener('click', resumeAudio, { once: true });
            document.addEventListener('touchstart', resumeAudio, { once: true });
            document.addEventListener('keydown', resumeAudio, { once: true });
            
            return instance;
          };
          
          // Copy prototype properties
          window.AudioContext.prototype = originalConstructor.prototype;
          if (window.webkitAudioContext) {
            window.webkitAudioContext.prototype = originalConstructor.prototype;
          }
          
          console.log('AudioContext patched to auto-resume on user interaction');
        }
      };
      
      // Apply the fix when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        window.fixAudioContext();
      });
    </script>
    
    <!-- WebGazer eye tracking library -->
    <script>
      // Handle WebGazer initialization properly to avoid duplicate registrations
      window.webgazerInitialized = false;
      
      function initializeWebGazer() {
        if (window.webgazerInitialized) {
          console.log('WebGazer already initialized, skipping');
          return;
        }
        
        console.log('Initializing WebGazer eye tracking');
        
        // Create a script element
        const script = document.createElement('script');
        script.src = './webgazer-2.0.1.js';
        
        script.onload = function() {
          console.log('WebGazer loaded successfully');
          window.webgazerInitialized = true;
          
          // Prevent multiple initializations
          if (window.webgazer && typeof window.webgazer.begin === 'function') {
            // Don't auto-start WebGazer - let the experiment control it
            console.log('WebGazer ready to be used by experiment');
          }
        };
        
        script.onerror = function() {
          console.error('Failed to load WebGazer from primary file, trying alternate...');
          const altScript = document.createElement('script');
          altScript.src = './webgazer-2.0.1.tp.js';
          
          altScript.onload = function() {
            console.log('Alternate WebGazer loaded successfully');
            window.webgazerInitialized = true;
          };
          
          altScript.onerror = function() {
            console.error('WebGazer not available - eye tracking will not be used');
            document.getElementById('root').innerHTML += '<div style="color: red; padding: 10px; border: 1px solid red; margin: 10px; font-family: sans-serif;"><h3>WebGazer Failed to Load</h3><p>The eye tracking library could not be loaded. The experiment will not function correctly.</p></div>';
          };
          
          document.head.appendChild(altScript);
        };
        
        document.head.appendChild(script);
      }
      
      // Initialize WebGazer when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeWebGazer, 500); // Slight delay to avoid race conditions
      });
    </script>
    
    <!-- PsychoJS library -->
    <script src="./lib/psychojs-2021.2.3.js" defer></script>
    
    <!-- PsychoJS compatibility wrapper -->
    <script>
      // Ensure PsychoJS global object is properly initialized
      window.addEventListener('DOMContentLoaded', function() {
        // Safety check
        if (typeof window.psychoJS === 'undefined') {
          console.error('PsychoJS library failed to initialize');
          document.getElementById('root').innerHTML = '<div style="color: red; margin: 20px; font-family: sans-serif;">' +
            '<h1>Error Loading PsychoJS</h1>' +
            '<p>The experiment library could not be loaded.</p>' +
            '<p>Please try refreshing the page or check your internet connection.</p>' +
            '</div>';
        } else {
          console.log('PsychoJS library initialized successfully');
          
          // Monkey-patch the PsychoJS resource loading to handle ES6 modules
          if (window.createjs && window.createjs.LoadQueue) {
            const originalLoadJavascript = window.createjs.LoadQueue.prototype._loadJavascript;
            window.createjs.LoadQueue.prototype._loadJavascript = function(item) {
              // Check if this is the main experiment file
              if (item.src.includes('extended_session_experiment.js')) {
                console.log('Detected experiment module loading attempt, redirecting to wrapper');
                item.src = './extended_session_experiment-no-modules.js';
              }
              return originalLoadJavascript.call(this, item);
            };
          }
        }
      });
    </script>
    
    <!-- Module wrapper for experiment -->
    <script type="module">
      // Directly import PsychoJS as an ES module
      import { core, data, sound, util, visual } from './lib/psychojs-2021.2.3.js';
      
      // Store in a global location for non-module scripts
      window.psychoJSModule = { core, data, sound, util, visual };
      
      // Log success
      addDebugMessage('PsychoJS library imported successfully as ES module');
      
      // Provide access to util for other scripts
      window._expUtil = util;
      window._expVisual = visual;
      window._expCore = core;
      window._expData = data;
      window._expSound = sound;
    </script>
    
    <script type="module" src="./extended_session_experiment-module-wrapper.js"></script>
    
    <!-- Fallback for browsers that don't support modules -->
    <script nomodule>
      // Create a script element for non-module version
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Loading non-module version for browser compatibility');
        var script = document.createElement('script');
        script.src = './extended_session_experiment-no-modules.js';
        script.onerror = function() {
          document.getElementById('root').innerHTML = '<div style="color: red; margin: 20px; font-family: sans-serif;">' +
            '<h1>Error Loading Experiment</h1>' +
            '<p>The experiment script could not be loaded.</p>' +
            '<p>Please try using a modern browser like Chrome, Firefox, or Edge.</p>' +
            '</div>';
        };
        document.body.appendChild(script);
      });
    </script>
    
    <!-- Legacy browsers support -->
    <script nomodule src="./extended_session_experiment-legacy-browsers.js"></script>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Debug and status panels (initially hidden) -->
    <div id="experiment-status" style="position: fixed; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; z-index: 1000; display: none;">
      <div>Status: <span id="status-text">Initializing...</span></div>
      <div>PsychoJS: <span id="psychojs-status">Loading...</span></div>
      <div>WebGazer: <span id="webgazer-status">Not initialized</span></div>
      <button onclick="toggleDebugPanel()" style="background: #444; color: white; border: none; padding: 2px 5px; margin-top: 5px; cursor: pointer; font-size: 10px; border-radius: 3px;">Show Debug Log</button>
    </div>
    
    <div id="debug-panel" style="position: fixed; bottom: 70px; left: 10px; background-color: rgba(0,0,0,0.9); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 10px; max-width: 800px; max-height: 300px; overflow-y: auto; white-space: pre; z-index: 1000; display: none;"></div>
    
    <script>
      // Toggle debug panel visibility
      function toggleDebugPanel() {
        const panel = document.getElementById('debug-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        
        // Update button text
        const button = document.querySelector('#experiment-status button');
        button.textContent = panel.style.display === 'none' ? 'Show Debug Log' : 'Hide Debug Log';
      }
      
      // Show experiment status
      document.addEventListener('DOMContentLoaded', function() {
        // Show status panel after a short delay
        setTimeout(function() {
          const statusPanel = document.getElementById('experiment-status');
          if (statusPanel) statusPanel.style.display = 'block';
          
          // Update status based on loaded components
          const psychojsStatus = document.getElementById('psychojs-status');
          if (psychojsStatus) {
            psychojsStatus.textContent = window.psychoJS ? 'Loaded' : 'Not loaded';
            psychojsStatus.style.color = window.psychoJS ? '#4CAF50' : '#F44336';
          }
          
          const webgazerStatus = document.getElementById('webgazer-status');
          if (webgazerStatus) {
            webgazerStatus.textContent = window.webgazer ? 'Loaded' : 'Not loaded';
            webgazerStatus.style.color = window.webgazer ? '#4CAF50' : '#F44336';
          }
          
          const statusText = document.getElementById('status-text');
          if (statusText) {
            statusText.textContent = 'Ready';
          }
        }, 2000);
      });
    </script>
  </body>
</html>
