<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Extended Session [PsychoJS]</title>
    <!-- styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="./lib/psychojs-2021.2.3.css">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./eye-favicon.svg">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYAhgYGAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBGCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYAj///8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYAj///8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgCP///xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYGAI////EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    <script>
      // Error handling for missing JavaScript files
      window.addEventListener('error', function(e) {
        if (e.message.includes('404') || e.message.includes('Failed to load resource')) {
          console.error('Resource failed to load:', e.target.src || e.target.href);
          document.getElementById('root').innerHTML = '<div style="color: red; margin: 20px; font-family: sans-serif;">' +
            '<h1>Error Loading Resources</h1>' +
            '<p>Failed to load: ' + (e.target.src || e.target.href) + '</p>' +
            '<p>Please check that all files are present in the correct location.</p>' +
            '</div>';
        }
      }, true);
    </script>
  </head>
  <body>
    <div id="root"></div>
    <!-- external libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/preloadjs@1.0.1/lib/preloadjs.min.js"></script>
    
    <!-- PsychoJS configuration -->
    <script type="text/javascript">
      window.psychoJS = {
        debug: true,
        collectIP: false,
        hosts: {
          local: '',
          pavlovia: 'https://pavlovia.org'
        },
        log: function() {
          if (window.psychoJS.debug) {
            console.log.apply(console, arguments);
          }
        },
      };
    </script>
    
    <!-- PsychoJS libraries - load before WebGazer -->
    <script src="./lib/psychojs-2021.2.3.js" 
      onload="console.log('PsychoJS library loaded successfully')"
      onerror="console.error('Failed to load PsychoJS library'); document.getElementById('root').innerHTML = '<div style=\'color: red; margin: 20px; font-family: sans-serif;\'><h1>Error Loading PsychoJS</h1><p>The PsychoJS library failed to load. Check the file path: ./lib/psychojs-2021.2.3.js</p></div>'"></script>
    
    <!-- WebGazer eye tracking library - load synchronously before experiment script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing resources...');
        
        // First load WebGazer
        const loadWebGazer = new Promise(function(resolve, reject) {
          const script = document.createElement('script');
          script.src = './webgazer-2.0.1.js';
          script.onload = function() {
            console.log('WebGazer loaded successfully from primary file');
            resolve('primary');
          };
          script.onerror = function() {
            console.error('Failed to load WebGazer from webgazer-2.0.1.js. Trying alternate file...');
            const altScript = document.createElement('script');
            altScript.src = './webgazer-2.0.1.tp.js';
            altScript.onload = function() {
              console.log('WebGazer loaded successfully from alternate file');
              resolve('alternate');
            };
            altScript.onerror = function() {
              reject('Failed to load WebGazer from both files');
            };
            document.head.appendChild(altScript);
          };
          document.head.appendChild(script);
        });
        
        // Then load experiment script after WebGazer is ready
        loadWebGazer.then(function(source) {
          console.log(`WebGazer loaded from ${source} source, now loading experiment script...`);
          
          const expScript = document.createElement('script');
          expScript.src = './extended_session_experiment.js';
          expScript.type = 'module';
          expScript.onload = function() {
            console.log('Experiment script loaded successfully');
          };
          expScript.onerror = function() {
            console.error('Failed to load experiment script');
            document.getElementById('root').innerHTML += '<div style="color: red; padding: 10px; border: 1px solid red; margin: 10px; font-family: sans-serif;">' +
              '<h3>Experiment Script Failed to Load</h3>' +
              '<p>The main experiment script could not be loaded. Check the file path and console for errors.</p>' +
              '</div>';
          };
          document.body.appendChild(expScript);
          
          // Legacy browsers support
          const legacyScript = document.createElement('script');
          legacyScript.src = './extended_session_experiment-legacy-browsers.js';
          legacyScript.setAttribute('nomodule', '');
          document.body.appendChild(legacyScript);
        }).catch(function(error) {
          console.error(error);
          document.getElementById('root').innerHTML += '<div style="color: red; padding: 10px; border: 1px solid red; margin: 10px; font-family: sans-serif;">' +
            '<h3>WebGazer Failed to Load</h3>' +
            '<p>The eye tracking library could not be loaded. The experiment will not function correctly.</p>' +
            '<p>Error: ' + error + '</p>' +
            '</div>';
        });
      });
    </script>
  </body>
</html>
