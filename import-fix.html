<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Extended Session [PsychoJS] - Fixed Version</title>
    <!-- styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="./lib/psychojs-2021.2.3.css">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./eye-favicon.svg">
    
    <style>
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #333;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: Arial, sans-serif;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .log-item {
        margin: 5px 0;
        font-size: 14px;
      }
      .success { color: #4CAF50; }
      .error { color: #F44336; }
      .warning { color: #FFC107; }
      #loader-log {
        width: 80%;
        max-width: 600px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
        padding: 10px;
        background-color: rgba(0,0,0,0.3);
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div id="loading-screen">
      <div class="loader"></div>
      <h2>Loading Experiment Resources</h2>
      <div id="load-status">Initializing...</div>
      <div id="loader-log"></div>
    </div>
    
    <div id="root"></div>
    
    <script>
      // Logging function
      function logMessage(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        const logContainer = document.getElementById('loader-log');
        const logItem = document.createElement('div');
        logItem.className = `log-item ${type}`;
        logItem.textContent = message;
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      // Update loading status
      function updateStatus(message) {
        document.getElementById('load-status').textContent = message;
      }
      
      // Error handling for missing JavaScript files
      window.addEventListener('error', function(e) {
        if (e.message.includes('404') || e.message.includes('Failed to load resource')) {
          logMessage(`Resource failed to load: ${e.target.src || e.target.href}`, 'error');
        }
      }, true);
      
      // Initialize PsychoJS global configuration
      window.psychoJS = {
        debug: true,
        collectIP: false,
        hosts: {
          local: '',
          pavlovia: 'https://pavlovia.org'
        },
        log: function() {
          if (window.psychoJS.debug) {
            console.log.apply(console, arguments);
          }
        },
        // Initialize core namespace
        core: {},
        data: {},
        util: {},
        visual: {}
      };
      
      // Sequential resource loader
      async function loadResources() {
        try {
          // Step 1: Load external libraries
          updateStatus('Loading external libraries...');
          
          await loadScript('https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js');
          logMessage('jQuery loaded successfully');
          
          await loadScript('https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.js');
          logMessage('jQuery UI loaded successfully');
          
          await loadScript('https://cdn.jsdelivr.net/npm/preloadjs@1.0.1/lib/preloadjs.min.js');
          logMessage('PreloadJS loaded successfully');
          
          // Step 2: Load WebGazer
          updateStatus('Loading WebGazer eye tracking library...');
          try {
            await loadScript('./webgazer-2.0.1.js');
            logMessage('WebGazer loaded from primary file');
          } catch (err) {
            logMessage('Failed to load primary WebGazer, trying alternate...', 'warning');
            await loadScript('./webgazer-2.0.1.tp.js');
            logMessage('WebGazer loaded from alternate file');
          }
          
          // Step 3: Load PsychoJS
          updateStatus('Loading PsychoJS library...');
          await loadScript('./lib/psychojs-2021.2.3.js');
          logMessage('PsychoJS library loaded successfully');
          
          // Wait a moment to ensure everything is initialized
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Step 4: Load experiment as ES module
          updateStatus('Starting experiment...');
          logMessage('Loading experiment script');
          
          // Create a new script element for the experiment
          const experimentScript = document.createElement('script');
          experimentScript.src = './extended_session_experiment-no-modules.js';
          experimentScript.onload = () => {
            logMessage('Experiment loaded successfully');
            document.getElementById('loading-screen').style.display = 'none';
          };
          experimentScript.onerror = (error) => {
            logMessage(`Failed to load experiment: ${error}`, 'error');
            updateStatus('Error loading experiment');
          };
          document.body.appendChild(experimentScript);
          
        } catch (error) {
          updateStatus('Error loading resources');
          logMessage(`Loading failed: ${error.message}`, 'error');
          console.error('Resource loading failed:', error);
        }
      }
      
      // Helper to load scripts with promises
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Failed to load ${src}`));
          document.head.appendChild(script);
        });
      }
      
      // Start loading when DOM is ready
      document.addEventListener('DOMContentLoaded', loadResources);
    </script>
  </body>
</html> 